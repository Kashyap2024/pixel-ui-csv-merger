<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PixelMerge | CSV Tool</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <!-- PapaParse for robust CSV handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts: Space Mono for that Pixel/Tech vibe -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --pixel-black: #1a1a1a;
            --pixel-white: #ffffff;
            --pixel-bg: #f0f0f4;
            --pixel-accent: #8b5cf6;
            /* Violet */
            --pixel-accent-hover: #a78bfa;
            --pixel-success: #22c55e;
            /* Green */
            --pixel-card-bg: #ffffff;
            --pixel-border: #1a1a1a;
            --pixel-subtle: #e4e4e7;
            --pixel-text: #1a1a1a;
            --pixel-text-muted: #6b7280;
        }

        .dark {
            --pixel-black: #0a0a0a;
            --pixel-white: #1a1a1a;
            --pixel-bg: #121214;
            --pixel-accent: #a78bfa;
            --pixel-accent-hover: #c4b5fd;
            --pixel-success: #4ade80;
            --pixel-card-bg: #1e1e24;
            --pixel-border: #ffffff;
            --pixel-subtle: #2d2d35;
            --pixel-text: #f9fafb;
            --pixel-text-muted: #9ca3af;
        }

        body {
            font-family: 'Space Mono', monospace;
            background-color: var(--pixel-bg);
            background-image: radial-gradient(var(--pixel-border) 1px, transparent 1px);
            background-size: 24px 24px;
            color: var(--pixel-text);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Custom Pixel/Brutalist Utilities */
        .pixel-box {
            background: var(--pixel-card-bg);
            border: 3px solid var(--pixel-border);
            box-shadow: 6px 6px 0px 0px var(--pixel-border);
            transition: all 0.2s ease-in-out;
            color: var(--pixel-text);
        }

        .pixel-box:hover {
            transform: translate(-2px, -2px);
            box-shadow: 8px 8px 0px 0px var(--pixel-border);
        }

        .pixel-btn {
            border: 3px solid var(--pixel-border);
            box-shadow: 4px 4px 0px 0px var(--pixel-border);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.1s;
        }

        .pixel-btn:hover:not(:disabled) {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0px 0px var(--pixel-border);
        }

        .pixel-btn:active:not(:disabled) {
            transform: translate(2px, 2px);
            box-shadow: 0px 0px 0px 0px var(--pixel-border);
        }

        .pixel-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .pixel-input {
            border: 3px solid var(--pixel-border);
            background: var(--pixel-white);
            color: var(--pixel-text);
            padding: 0.5rem;
            outline: none;
            transition: box-shadow 0.2s;
        }

        .pixel-input:focus {
            box-shadow: 4px 4px 0px 0px var(--pixel-accent);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        ::-webkit-scrollbar-track {
            background: var(--pixel-subtle);
            border-left: 2px solid var(--pixel-border);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--pixel-border);
            border: 2px solid var(--pixel-subtle);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--pixel-accent);
        }

        /* Drop Zone Dashed Animation */
        .drop-zone {
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='0' ry='0' stroke='%231A1A1AFF' stroke-width='4' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
            transition: all 0.2s;
        }

        .dark .drop-zone {
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='0' ry='0' stroke='%23FFFFFF' stroke-width='4' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
        }

        .drop-zone.active {
            background-color: var(--pixel-subtle);
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='0' ry='0' stroke='%238B5CF6FF' stroke-width='4' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
            transform: scale(0.99);
        }

        /* Loading Spinner */
        .pixel-spinner {
            width: 24px;
            height: 24px;
            border: 4px solid var(--pixel-border);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Utility overrides */
        .dark .bg-white {
            background-color: var(--pixel-card-bg);
        }

        .dark .border-black {
            border-color: var(--pixel-border);
        }

        .dark .text-black {
            color: var(--pixel-text);
        }

        .dark .bg-gray-50 {
            background-color: var(--pixel-subtle);
        }

        .dark .bg-gray-100 {
            background-color: var(--pixel-subtle);
        }

        .dark .border-gray-200 {
            border-color: var(--pixel-subtle);
        }

        .dark .text-gray-500 {
            color: var(--pixel-text-muted);
        }

        .dark .bg-purple-100 {
            background-color: var(--pixel-subtle);
        }

        /* Stats Bar & Version Badge Specifics */
        .dark .bg-blue-100 {
            background-color: rgba(59, 130, 246, 0.2);
        }

        .dark .bg-green-100 {
            background-color: rgba(34, 197, 94, 0.2);
        }

        .dark .bg-yellow-300 {
            background-color: var(--pixel-accent);
            color: var(--pixel-black);
        }

        .dark .shadow-\[4px_4px_0px_0px_black\] {
            box-shadow: 4px 4px 0px 0px var(--pixel-border);
        }

        .dark .shadow-\[2px_2px_0px_0px_black\] {
            box-shadow: 2px 2px 0px 0px var(--pixel-border);
        }
    </style>
</head>

<body class="min-h-screen flex flex-col p-4 md:p-8">

    <!-- Header -->
    <header class="mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
        <div class="flex items-center gap-3 bg-white border-4 border-black p-3 shadow-[4px_4px_0px_0px_black]">
            <i data-lucide="layers" class="w-8 h-8 text-purple-600"></i>
            <h1 class="text-2xl md:text-3xl font-bold tracking-tighter">PIXEL<span class="text-purple-600">MERGE</span>
            </h1>
        </div>

        <div class="flex items-center gap-4">
            <!-- Theme Toggle -->
            <button id="themeToggle" class="pixel-btn p-2 bg-white flex items-center justify-center"
                title="Toggle Theme">
                <i data-lucide="sun" class="w-5 h-5 block dark:hidden"></i>
                <i data-lucide="moon" class="w-5 h-5 hidden dark:block"></i>
            </button>

            <div
                class="text-sm font-bold bg-yellow-300 border-2 border-black px-3 py-1 shadow-[2px_2px_0px_0px_black] dark:bg-yellow-600 dark:text-black">
                v1.0.0_BETA
            </div>
        </div>
    </header>

    <main class="flex-1 w-full max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">

        <!-- Left Column: Inputs & Controls -->
        <section class="lg:col-span-4 flex flex-col gap-6">

            <!-- Upload Area -->
            <div id="dropZone"
                class="pixel-box p-6 relative group drop-zone bg-white min-h-[200px] flex flex-col items-center justify-center text-center cursor-pointer">
                <input type="file" id="fileInput" multiple accept=".csv"
                    class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                <div class="pointer-events-none flex flex-col items-center gap-4">
                    <div
                        class="w-16 h-16 bg-purple-100 border-2 border-black flex items-center justify-center shadow-[4px_4px_0px_0px_black]">
                        <i data-lucide="upload-cloud" class="w-8 h-8 text-black"></i>
                    </div>
                    <div>
                        <p class="font-bold text-lg">DROP CSV FILES HERE</p>
                        <p class="text-xs text-gray-500 mt-1">OR CLICK TO BROWSE</p>
                    </div>
                </div>
            </div>

            <!-- Settings -->
            <div class="pixel-box p-5 bg-white">
                <h2 class="font-bold text-lg mb-4 flex items-center gap-2">
                    <i data-lucide="settings-2" class="w-5 h-5"></i> CONFIG
                </h2>
                <div class="space-y-3">
                    <label class="flex items-center gap-3 cursor-pointer group">
                        <div class="relative">
                            <input type="checkbox" id="filenameCol" class="peer sr-only">
                            <div
                                class="w-6 h-6 border-2 border-black bg-white peer-checked:bg-purple-500 transition-all shadow-[2px_2px_0px_0px_rgba(0,0,0,0.2)]">
                            </div>
                            <i data-lucide="check"
                                class="w-4 h-4 text-white absolute top-1 left-1 opacity-0 peer-checked:opacity-100 transition-opacity"></i>
                        </div>
                        <span class="text-sm font-bold group-hover:text-purple-600 transition-colors">Add 'Source File'
                            column</span>
                    </label>

                    <label class="flex items-center gap-3 cursor-pointer group">
                        <div class="relative">
                            <input type="checkbox" id="skipEmpty" checked class="peer sr-only">
                            <div
                                class="w-6 h-6 border-2 border-black bg-white peer-checked:bg-purple-500 transition-all shadow-[2px_2px_0px_0px_rgba(0,0,0,0.2)]">
                            </div>
                            <i data-lucide="check"
                                class="w-4 h-4 text-white absolute top-1 left-1 opacity-0 peer-checked:opacity-100 transition-opacity"></i>
                        </div>
                        <span class="text-sm font-bold group-hover:text-purple-600 transition-colors">Skip empty
                            rows</span>
                    </label>
                </div>
            </div>

            <!-- File List -->
            <div class="pixel-box p-5 bg-white flex-1 flex flex-col min-h-[300px]">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-lg flex items-center gap-2">
                        <i data-lucide="files" class="w-5 h-5"></i> QUEUE <span id="fileCountBadge"
                            class="bg-black text-white text-xs px-2 py-0.5 rounded-none hidden">0</span>
                    </h2>
                    <button id="clearBtn" class="text-xs hover:text-red-600 underline font-bold hidden">CLEAR
                        ALL</button>
                </div>

                <div id="fileList" class="flex-1 overflow-y-auto space-y-3 pr-2 max-h-[400px]">
                    <!-- Empty State -->
                    <div id="emptyState"
                        class="h-full flex flex-col items-center justify-center text-gray-400 border-2 border-dashed border-gray-300 p-4">
                        <i data-lucide="ghost" class="w-8 h-8 mb-2 opacity-50"></i>
                        <span class="text-xs">NO FILES YET</span>
                    </div>
                </div>

                <div class="mt-4 pt-4 border-t-2 border-black border-dashed">
                    <button id="mergeBtn" disabled
                        class="pixel-btn w-full bg-purple-500 hover:bg-purple-400 text-white py-4 flex items-center justify-center gap-2">
                        <span>MERGE FILES</span>
                        <i data-lucide="arrow-right" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- Right Column: Preview & Results -->
        <section class="lg:col-span-8 flex flex-col h-full">
            <div class="pixel-box p-0 bg-white flex flex-col h-full relative overflow-hidden">
                <!-- Toolbar -->
                <div class="border-b-4 border-black p-4 flex flex-wrap justify-between items-center bg-gray-50 gap-4">
                    <h2 class="font-bold text-xl flex items-center gap-2">
                        <i data-lucide="eye" class="w-6 h-6"></i> DATA PREVIEW
                    </h2>

                    <div id="statsBar" class="hidden flex items-center gap-4 text-xs md:text-sm">
                        <div class="px-3 py-1 bg-blue-100 border-2 border-black shadow-[2px_2px_0px_0px_black]">
                            ROWS: <span id="totalRows" class="font-bold">0</span>
                        </div>
                        <div class="px-3 py-1 bg-green-100 border-2 border-black shadow-[2px_2px_0px_0px_black]">
                            COLS: <span id="totalCols" class="font-bold">0</span>
                        </div>
                    </div>
                </div>

                <!-- Table Container -->
                <div class="flex-1 overflow-auto bg-white relative min-h-[400px]">
                    <div id="loadingOverlay"
                        class="hidden absolute inset-0 bg-white/90 z-20 flex flex-col items-center justify-center">
                        <div class="pixel-spinner border-purple-600 mb-4"></div>
                        <p class="font-bold animate-pulse">CRUNCHING DATA...</p>
                    </div>

                    <table id="previewTable" class="w-full text-left border-collapse hidden">
                        <thead class="bg-black text-white sticky top-0 z-10">
                            <tr id="tableHeadRow"></tr>
                        </thead>
                        <tbody id="tableBody" class="font-mono text-sm"></tbody>
                    </table>

                    <!-- Table Placeholder -->
                    <div id="previewPlaceholder"
                        class="absolute inset-0 flex flex-col items-center justify-center opacity-30 pointer-events-none">
                        <div class="grid grid-cols-4 gap-4 w-3/4 max-w-md">
                            <div class="h-4 bg-black/20 col-span-1"></div>
                            <div class="h-4 bg-black/20 col-span-3"></div>
                            <div class="h-4 bg-black/20 col-span-2"></div>
                            <div class="h-4 bg-black/20 col-span-2"></div>
                            <div class="h-4 bg-black/20 col-span-4"></div>
                        </div>
                        <p class="mt-8 font-bold text-xl">WAITING FOR DATA INPUT...</p>
                    </div>
                </div>

                <!-- Footer Actions -->
                <div class="border-t-4 border-black p-4 bg-gray-50 flex justify-end">
                    <button id="downloadBtn" disabled
                        class="pixel-btn bg-green-500 hover:bg-green-400 text-white px-8 py-3 flex items-center gap-2">
                        <i data-lucide="download" class="w-5 h-5"></i>
                        DOWNLOAD MERGED CSV
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- JS Logic -->
    <script>
        // --- State Management ---
        const state = {
            files: [], // Array of File objects
            mergedData: null,
            isProcessing: false
        };

        // --- DOM Elements ---
        const els = {
            themeToggle: document.getElementById('themeToggle'),
            dropZone: document.getElementById('dropZone'),
            fileInput: document.getElementById('fileInput'),
            fileList: document.getElementById('fileList'),
            emptyState: document.getElementById('emptyState'),
            mergeBtn: document.getElementById('mergeBtn'),
            clearBtn: document.getElementById('clearBtn'),
            fileCountBadge: document.getElementById('fileCountBadge'),
            previewTable: document.getElementById('previewTable'),
            tableHeadRow: document.getElementById('tableHeadRow'),
            tableBody: document.getElementById('tableBody'),
            previewPlaceholder: document.getElementById('previewPlaceholder'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            statsBar: document.getElementById('statsBar'),
            totalRows: document.getElementById('totalRows'),
            totalCols: document.getElementById('totalCols'),
            downloadBtn: document.getElementById('downloadBtn'),
            filenameCol: document.getElementById('filenameCol'),
            skipEmpty: document.getElementById('skipEmpty')
        };

        // --- Initialize ---
        initTheme();
        lucide.createIcons();

        // --- Event Listeners ---
        els.themeToggle.addEventListener('click', toggleTheme);
        els.fileInput.addEventListener('change', handleFileSelect);

        // Drag & Drop Visuals
        els.dropZone.addEventListener('dragenter', () => els.dropZone.classList.add('active'));
        els.dropZone.addEventListener('dragleave', () => els.dropZone.classList.remove('active'));
        els.dropZone.addEventListener('drop', () => els.dropZone.classList.remove('active'));

        els.clearBtn.addEventListener('click', clearAll);
        els.mergeBtn.addEventListener('click', processMerge);
        els.downloadBtn.addEventListener('click', downloadCSV);

        // --- Theme Logic ---
        function initTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.theme = isDark ? 'dark' : 'light';
            // Lucide icons need re-creation or manual toggle
            lucide.createIcons();
        }

        // --- File Handling ---
        function handleFileSelect(e) {
            const newFiles = Array.from(e.target.files);
            addFiles(newFiles);
            // Reset input so same file can be selected again if needed
            e.target.value = '';
        }

        function addFiles(files) {
            // Filter only CSVs
            const validFiles = files.filter(f => f.name.toLowerCase().endsWith('.csv') || f.type === 'text/csv' || f.type === 'application/vnd.ms-excel');

            if (validFiles.length === 0 && files.length > 0) {
                alert("Please upload valid .csv files.");
                return;
            }

            state.files = [...state.files, ...validFiles];
            updateUI();
        }

        function removeFile(index) {
            state.files.splice(index, 1);
            // If we remove files, invalidate the current merged result
            resetMergeResult();
            updateUI();
        }

        function clearAll() {
            state.files = [];
            resetMergeResult();
            updateUI();
        }

        function resetMergeResult() {
            state.mergedData = null;
            els.previewTable.classList.add('hidden');
            els.previewPlaceholder.classList.remove('hidden');
            els.statsBar.classList.add('hidden');
            els.downloadBtn.disabled = true;
            els.downloadBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }

        function updateUI() {
            // Render File List
            els.fileList.innerHTML = '';

            if (state.files.length === 0) {
                els.fileList.appendChild(els.emptyState);
                els.clearBtn.classList.add('hidden');
                els.fileCountBadge.classList.add('hidden');
                els.mergeBtn.disabled = true;
            } else {
                els.clearBtn.classList.remove('hidden');
                els.fileCountBadge.textContent = state.files.length;
                els.fileCountBadge.classList.remove('hidden');
                els.mergeBtn.disabled = false;

                state.files.forEach((file, index) => {
                    const card = document.createElement('div');
                    card.className = "flex items-center justify-between p-3 bg-gray-50 border-2 border-black shadow-[2px_2px_0px_0px_black] group hover:bg-white transition-colors";

                    const size = (file.size / 1024).toFixed(1) + ' KB';

                    card.innerHTML = `
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="bg-black text-white p-1.5">
                                <i data-lucide="file-text" class="w-4 h-4"></i>
                            </div>
                            <div class="min-w-0">
                                <p class="text-xs font-bold truncate">${file.name}</p>
                                <p class="text-[10px] text-gray-500 font-mono">${size}</p>
                            </div>
                        </div>
                        <button onclick="removeFile(${index})" class="p-1 hover:bg-red-100 border-2 border-transparent hover:border-red-500 transition-colors text-red-500">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    `;
                    els.fileList.appendChild(card);
                });
                lucide.createIcons();
            }
        }

        // --- Core Merge Logic ---
        async function processMerge() {
            if (state.files.length === 0) return;

            setLoading(true);

            // Small timeout to allow UI to update to loading state
            setTimeout(async () => {
                try {
                    const includeFilename = els.filenameCol.checked;
                    const skipEmpty = els.skipEmpty.checked;

                    const allResults = [];
                    const allHeaders = new Set();
                    if (includeFilename) allHeaders.add('Source File');

                    // 1. Parse all files
                    const parsePromises = state.files.map(file => {
                        return new Promise((resolve) => {
                            Papa.parse(file, {
                                header: true,
                                skipEmptyLines: skipEmpty,
                                complete: (results) => {
                                    // Collect headers
                                    if (results.meta.fields) {
                                        results.meta.fields.forEach(h => allHeaders.add(h));
                                    }
                                    resolve({ name: file.name, data: results.data });
                                }
                            });
                        });
                    });

                    const parsedFiles = await Promise.all(parsePromises);

                    // 2. Normalize Data (Union of headers)
                    const headerArray = Array.from(allHeaders);
                    const mergedRows = [];

                    parsedFiles.forEach(fileObj => {
                        fileObj.data.forEach(row => {
                            const newRow = {};

                            // Initialize all keys with empty string to ensure CSV uniformity
                            headerArray.forEach(h => newRow[h] = "");

                            // Fill data
                            if (includeFilename) {
                                newRow['Source File'] = fileObj.name;
                            }

                            // Map existing data
                            Object.keys(row).forEach(key => {
                                // Simple mapping; handles basic case sensitivity if exact match
                                if (headerArray.includes(key)) {
                                    newRow[key] = row[key];
                                }
                            });

                            mergedRows.push(newRow);
                        });
                    });

                    state.mergedData = {
                        fields: headerArray,
                        data: mergedRows
                    };

                    renderPreview();

                } catch (err) {
                    console.error(err);
                    alert("Error processing files. See console for details.");
                } finally {
                    setLoading(false);
                }
            }, 100);
        }

        function setLoading(isLoading) {
            state.isProcessing = isLoading;
            if (isLoading) {
                els.loadingOverlay.classList.remove('hidden');
                els.mergeBtn.disabled = true;
                els.mergeBtn.innerHTML = `<div class="pixel-spinner w-5 h-5 border-white"></div> PROCESSING...`;
            } else {
                els.loadingOverlay.classList.add('hidden');
                els.mergeBtn.disabled = false;
                els.mergeBtn.innerHTML = `<span>MERGE FILES</span> <i data-lucide="arrow-right" class="w-5 h-5"></i>`;
                lucide.createIcons();
            }
        }

        function renderPreview() {
            if (!state.mergedData) return;

            // Update stats
            els.statsBar.classList.remove('hidden');
            els.totalRows.textContent = state.mergedData.data.length;
            els.totalCols.textContent = state.mergedData.fields.length;

            // Enable download
            els.downloadBtn.disabled = false;
            els.downloadBtn.classList.remove('opacity-50', 'cursor-not-allowed');

            // Hide placeholder, Show table
            els.previewPlaceholder.classList.add('hidden');
            els.previewTable.classList.remove('hidden');

            // Clear table
            els.tableHeadRow.innerHTML = '';
            els.tableBody.innerHTML = '';

            // Render Header
            state.mergedData.fields.forEach(header => {
                const th = document.createElement('th');
                th.className = "p-3 border-b-4 border-black border-r text-xs uppercase tracking-wider whitespace-nowrap bg-black text-white";
                th.textContent = header;
                els.tableHeadRow.appendChild(th);
            });

            // Render Body (Max 50 rows for performance)
            const previewRows = state.mergedData.data.slice(0, 50);

            previewRows.forEach((row, i) => {
                const tr = document.createElement('tr');
                tr.className = i % 2 === 0 ? "bg-white hover:bg-purple-50" : "bg-gray-50 hover:bg-purple-50";

                state.mergedData.fields.forEach(header => {
                    const td = document.createElement('td');
                    td.className = "p-3 border-b border-r border-gray-200 text-xs truncate max-w-[200px]";
                    td.textContent = row[header] || ""; // Handle empty cells
                    td.title = row[header] || ""; // Tooltip for truncated content
                    tr.appendChild(td);
                });
                els.tableBody.appendChild(tr);
            });

            // If truncated, add a note row
            if (state.mergedData.data.length > 50) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="${state.mergedData.fields.length}" class="p-4 text-center text-gray-500 italic bg-gray-100 border-b border-black">... ${state.mergedData.data.length - 50} more rows hidden from preview ...</td>`;
                els.tableBody.appendChild(tr);
            }
        }

        function downloadCSV() {
            if (!state.mergedData) return;

            const csv = Papa.unparse(state.mergedData);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");

            // Generate filename with timestamp
            const date = new Date();
            const timestamp = date.toISOString().replace(/[:.]/g, '-').slice(0, 19);
            const filename = `merged_data_${timestamp}.csv`;

            if (navigator.msSaveBlob) { // IE 10+
                navigator.msSaveBlob(blob, filename);
            } else {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

    </script>
</body>

</html>
